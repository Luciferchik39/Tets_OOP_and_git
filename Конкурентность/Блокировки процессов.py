from random import random
from multiprocessing import  Process, Lock
import os
from datetime import datetime
from time import sleep
from multiprocessing import RLock
"""
LOCK vs RLOCK:

üîí LOCK:
- –ü—Ä–æ—Å—Ç–æ–π "—Ñ–ª–∞–≥" (0 –∏–ª–∏ 1)
- –ù–µ–ª—å–∑—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –¥–≤–∞–∂–¥—ã –æ–¥–Ω–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
- –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–∫—Ü–∏–π
- –ë—ã—Å—Ç—Ä–µ–µ, –ª–µ–≥—á–µ

üîê RLOCK:
- –°—á–µ—Ç—á–∏–∫ –∑–∞—Ö–≤–∞—Ç–æ–≤
- –ú–æ–∂–Ω–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –æ–¥–Ω–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
- –î–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –î–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- –ù–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –∏–∑-–∑–∞ —Å—á–µ—Ç—á–∏–∫–∞

–ö–û–ì–î–ê –ß–¢–û:
- Lock: "–∑–∞—â–∏—â–∞—é –æ–¥–Ω—É –æ–ø–µ—Ä–∞—Ü–∏—é"
- RLock: "–∑–∞—â–∏—â–∞—é —Ü–µ–ø–æ—á–∫—É –æ–ø–µ—Ä–∞—Ü–∏–π, –≥–¥–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–∑—ã–≤–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞"

–ü–†–ê–í–ò–õ–û:
–í–ª–∞–¥–µ–ª–µ—Ü RLOCK = –ø—Ä–æ—Ü–µ—Å—Å
–°—á–µ—Ç—á–∏–∫ = —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∑–∞—Ö–≤–∞—Ç–∏–ª
–†–µ–∞–ª—å–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ = —Å—á–µ—Ç—á–∏–∫ 0

"""


def file_write(start: int, finish: int, l: Lock):
    l.acquire()
    for i in range(start, finish):
        with open('locker.txt', 'a', encoding='utf-8') as file:
            """
                    –†–µ–∂–∏–º	    –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç	                      –ï—Å–ª–∏ —Ñ–∞–π–ª –µ—Å—Ç—å
            'w' (write)	    ‚úÖ –°–æ–∑–¥–∞–µ—Ç	                //  ‚ôªÔ∏è   –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç (–æ—á–∏—â–∞–µ—Ç –∏ –ø–∏—à–µ—Ç –∑–∞–Ω–æ–≤–æ)
            'x' (exclusive)	‚úÖ –°–æ–∑–¥–∞–µ—Ç	                //  ‚ùå –û—à–∏–±–∫–∞ FileExistsError
            'a' (append)	‚úÖ –°–æ–∑–¥–∞–µ—Ç	                //  ‚ûï –î–æ–±–∞–≤–ª—è–µ—Ç –≤ –∫–æ–Ω–µ—Ü
            'r' (read)	    ‚ùå –û—à–∏–±–∫–∞ FileNotFoundError	//  ‚úÖ –ß–∏—Ç–∞–µ—Ç
                """

            sleep(.5)
            print(i)
            file.write(f'{i}\n')
    l.release()


class SafeList:
    def __init__(self):
        self.list = []
        self.lock = RLock() # ‚Äî —Å—á–µ—Ç—á–∏–∫ = 0, –≤–ª–∞–¥–µ–ª–µ—Ü = None

    def add(self, item):
        print('add –ø—ã—Ç–∞–µ–º—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å lock ')
        with self.lock:
            print('add lock –∑–∞—Ö–≤–∞—á–µ–Ω –°—á–µ—Ç—á–∏–∫ = 1')
            self.list.append(item)
            print(f'—ç–ª–µ–º–µ–Ω—Ç {item} –¥–æ–±–∞–≤–ª–µ–Ω –≤ {self.list}')
        print('add –∑–∞–≤–µ—Ä—à–∏–ª–æ –¥–µ–π—Å—Ç–≤–∏ with –∑–∞–≤–µ—Ä—à–∏–ª self.lock –°—á–µ—Ç—á–∏–∫ = 0')

    def extend(self, items):
        print('extend –ø—ã—Ç–∞–µ–º—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å lock ')
        with self.lock:
            print('extend lock –∑–∞—Ö–≤–∞—á–µ–Ω –°—á–µ—Ç—á–∏–∫ = 1')
            for el in items:
                self.add(el) # –µ—â—ë –æ–¥–∏–Ω –∑–∞—Ö–≤–∞—Ç –æ—Ç add –°—á–µ—Ç—á–∏–∫ = 2 –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è 1 –∏ —Ç–∞–∫ –ø–æ–∫–∞ –ø–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –Ω–µ –ø—Ä–æ–π–¥—ë–º
        print('extend –∑–∞–≤–µ—Ä—à–∏–ª–æ –¥–µ–π—Å—Ç–≤–∏ with –∑–∞–≤–µ—Ä—à–∏–ª self.lock –°—á–µ—Ç—á–∏–∫ = 0')

    def pop_el(self):
        print('pop_el –ø—ã—Ç–∞–µ–º—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å lock ')
        with self.lock:
            print('pop_el lock –∑–∞—Ö–≤–∞—á–µ–Ω –°—á–µ—Ç—á–∏–∫ = 1')
            if self.list: # –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –Ω–µ –ø—É—Å—Ç –≤—ã–ø–æ–ª–Ω–∏:
                print(f"pop: —Å–ø–∏—Å–æ–∫ –Ω–µ –ø—É—Å—Ç, —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π")
                return self.list.pop()
            else:
                print(f"pop: —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None")
                return None  # –∏–ª–∏ –º–æ–∂–Ω–æ raise IndexError
        print('pop_el –∑–∞–≤–µ—Ä—à–∏–ª–æ –¥–µ–π—Å—Ç–≤–∏ with –∑–∞–≤–µ—Ä—à–∏–ª self.lock –°—á–µ—Ç—á–∏–∫ = 0')

    def get_all(self):
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ø–∏—é –≤—Å–µ–≥–æ —Å–ø–∏—Å–∫–∞"""
        with self.lock:
            return self.list.copy()  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

def worker_add(shared_list, items, worker_name):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞: –¥–æ–±–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã"""
    print(f"\nüöÄ [{worker_name}] –ó–ê–ü–£–©–ï–ù")
    for item in items:
        shared_list.add(item)
        sleep(random())
    print(f"üèÅ [{worker_name}] –ó–ê–í–ï–†–®–ï–ù")

if __name__ == '__main__':
    print("=" * 60)
    print("üî∞ –°–û–ó–î–ê–ï–ú –û–ë–©–ò–ô SAFELIST")
    shared_list = SafeList()

    # –ù–∞–ø–æ–ª–Ω–∏–º –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    shared_list.extend([0, 0, 0])
    print(f"–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: {shared_list.get_all()}")
    print("=" * 60)
    l = Lock()
    print(f'–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å PID {os.getppid()}')
    start = datetime.now()
    p_1 = Process(target=file_write, args=(0, 5, l))
    p_2 = Process(target=file_write, args=(5, 10, l))
    p_1.start()
    p_2.start()
    p_1.join()
    p_2.join()
    print(f'–†–æ–¥–∏—Ç–µ–ª—å—Å–∏–∫–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –∑–∞: {datetime.now() - start}')

    print("\nüìå –≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢ 1: –î–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–æ–±–∞–≤–ª—è—é—Ç —ç–ª–µ–º–µ–Ω—Ç—ã")

    p1 = Process(target=worker_add, args=(shared_list, [1, 2, 3], "–ü–æ–≤–∞—Ä-1"))
    p2 = Process(target=worker_add, args=(shared_list, [4, 5, 6], "–ü–æ–≤–∞—Ä-2"))

    p1.start()
    p2.start()

    p1.join()
    p2.join()

    print(f"\nüìä –ò—Ç–æ–≥ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {shared_list.get_all()}")
    print("=" * 60)

"""
–ü–ï–†–ï–î–ê–ß–ê –û–ë–™–ï–ö–¢–û–í –í –ü–†–û–¶–ï–°–°–´:

‚ö†Ô∏è –í–ê–ñ–ù–û: –û–±—ä–µ–∫—Ç—ã –ù–ï —Ä–∞–∑–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏!

–ß–¢–û –ü–†–û–ò–°–•–û–î–ò–¢:
1. –û–±—ä–µ–∫—Ç —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è (pickle)
2. –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
3. –¢–∞–º —Å–æ–∑–¥–∞–µ—Ç—Å—è –ù–û–í–ê–Ø –ö–û–ü–ò–Ø
4. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–ø–∏–∏ –ù–ï –≤–∏–¥–Ω—ã —Ä–æ–¥–∏—Ç–µ–ª—é

–ö–ê–ö –û–ë–ú–ï–ù–ò–í–ê–¢–¨–°–Ø:
‚úÖ Queue - –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
‚úÖ Pipe - –¥–ª—è –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π —Å–≤—è–∑–∏
‚úÖ Manager - –¥–ª—è "–∂–∏–≤—ã—Ö" –æ–±—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
‚úÖ shared_memory - –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö

–¢–í–û–ô –°–õ–£–ß–ê–ô:
–¢—ã –≤–∏–¥–µ–ª –≤—ã–≤–æ–¥—ã –≤ –∫–æ–Ω—Å–æ–ª—å (–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ stdout),
–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –æ—Å—Ç–∞–ª–∏—Å—å –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö!
"""
